<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Asociación de Bochas de Alta Gracia</title>
<link rel="icon" type="image/png" href="logo-asociacion-removebg-preview.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- BASE DE DATOS -->
<script src="database.js"></script>
<link rel="stylesheet" href="styles.css">

<style>
/* ================= RESET ================= */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  overflow-x: hidden;
  font-family: Arial, Helvetica, sans-serif;
  background: #f4f4f4;
  font-size: 18px;
  color: #111;
}

/* ================= HEADER ================= */
.main-header {
  background: #c30000;
  color: #fff;
  padding: 18px 30px;
  position: relative;
}

.logo {
  position: absolute;
  left: 20px;
  top: 50%;
  transform: translateY(-50%);
  height: 90px;
  width: auto;
}

.header-center {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

.header-center h1 {
  font-size: 30px;
  margin-bottom: 8px;
}

.header-center nav button {
  margin: 0 6px;
  padding: 10px 22px;
  font-size: 17px;
  cursor: pointer;
  border: none;
  background: #fff;
  color: #8b0000;
  border-radius: 4px;
}

.header-center nav button:hover {
  background: #eee;
}

/* ================= SECCIONES ================= */
.section {
  display: none;
  padding: 20px;
}

.section.active {
  display: block;
}

/* ================= LAYOUT INICIO ================= */
.layout {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}

.box {
  background: #fff;
  padding: 20px;
  border-radius: 6px;
  flex: 1 1 300px;
}

/* ================= CLUBES ================= */
.club-card {
  border: 1px solid #ccc;
  padding: 20px;
  margin-bottom: 20px;
  background: #fff;
}

.club-details {
  display: none;
  margin-top: 15px;
  padding: 15px;
  background: #eef;
}

/* ================= TABLA JUGADORES ================= */
.table-wrapper {
  overflow-x: auto;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 15px;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 900px;
}

th, td {
  border: 1px solid #999;
  padding: 10px;
  text-align: center;
  white-space: nowrap;
}

th {
  background: #0b4f6c;
  color: #fff;
  position: sticky;
  top: 0;
  z-index: 2;
}

.sortable-header {
  cursor: pointer;
}

.sortable-header.active-sort {
  background: #083a50;
}

.sortable-header span[aria-hidden="true"] {
  opacity: 0.25;
}

.sortable-header.active-sort span[aria-hidden="true"] {
  opacity: 1;
}


.sort-active-indicator {
  margin: 10px 0 14px;
  font-size: 14px;
  color: #333;
}

.sort-active-indicator strong {
  color: #0b4f6c;
}


/* ================= MOBILE ================= */
@media (max-width: 768px) {
  .main-header {
    padding: 14px 12px;
  }

  .logo {
    left: 12px;
    top: 12px;
    transform: none;
    height: 60px;
  }

  .header-center {
    margin-left: 90px;
    align-items: flex-start;
    text-align: left;
  }

  .header-center h1 {
    font-size: 20px;
    line-height: 1.25;
  }

  .header-center nav {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .header-center nav button {
    font-size: 14px;
    padding: 7px 14px;
  }

  .layout {
    flex-direction: column;
  }

  #jugadores table {
    min-width: 600px;
    font-size: 13px;
  }
}
</style>
</head>

<body>

<header class="main-header">
  <img src="logo-asociacion.png" alt="Logo Asociación" class="logo">
  <div class="header-center">
    <h1>Asociación de Bochas de Alta Gracia</h1>
    <nav>
      <button onclick="showSection('inicio')">Inicio</button>
      <button onclick="showSection('clubes')">Clubes</button>
      <button onclick="showSection('jugadores')">Jugadores</button>
    </nav>
  </div>
</header>

<!-- ================= INICIO ================= -->
<section id="inicio" class="section active">
  <div class="layout">
    <div class="box">
      <h2>Calendario</h2>
      <iframe src="https://calendar.google.com/calendar/embed?ctz=America/Argentina/Cordoba" style="border:0" width="100%" height="400"></iframe>
      <hr style="margin:20px 0;">
      <h2>Torneos Federados</h2>
      <div id="torneosFederados"></div>
    </div>

    <section id="torneo" class="box">
      <h2>Torneo</h2>
      <div id="torneoActivo"></div>
      <hr style="margin:20px 0;">
      <h3>Próximos partidos</h3>
      <div id="torneoProximosPartidos"></div>
      <hr style="margin:20px 0;">
      <h3>Torneos Internos</h3>
      <div id="torneosInternos"></div>
    </section>
  </div>
</section>

<!-- ================= CLUBES ================= -->
<section id="clubes" class="section">
  <h2>Clubes Asociados</h2>
  <div id="clubesContainer"></div>
</section>

<!-- ================= JUGADORES ================= -->
<section id="jugadores" class="section">
  <h2>Seguimiento de Jugadores</h2>
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th class="sortable-header" data-field="nombre" onclick="toggleSortCriterion('nombre')">Nombre <span aria-hidden="true">●</span></th>
          <th class="sortable-header" data-field="club_id" onclick="toggleSortCriterion('club_id')">Club <span aria-hidden="true">●</span></th>
          <th class="sortable-header" data-field="categoria" onclick="toggleSortCriterion('categoria')">Categoría <span aria-hidden="true">●</span></th>
          <th class="sortable-header" data-field="torneos" onclick="toggleSortCriterion('torneos')">Jugados <span aria-hidden="true">●</span></th>
          <th>1° Partido</th>
          <th>2° Partido</th>
          <th>3° Partido</th>
          <th>4° Partido</th>
          <th>5° Partido</th>
          <th>Semifinal</th>
          <th>Subcampeón</th>
          <th>Campeón</th>
        </tr>
      </thead>
      <tbody id="tablaJugadoresBody"></tbody>
    </table>
  </div>
  <p id="sortActiveIndicator" class="sort-active-indicator">Orden activo: ninguno</p>
</section>

<script>
const categoryOrder = { Primera: 3, Segunda: 2, Tercera: 1 };
let sortCriteria = [];
const sortFieldOrder = ["nombre", "club_id", "categoria", "torneos"];

/* ================= Navegación ================= */
function showSection(id){
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');

  if(id === "jugadores"){
    cargarJugadores();
  }
}

function toggle(id){
  const e = document.getElementById(id);
  e.style.display = e.style.display === 'block' ? 'none' : 'block';
}

function updateSortHeaders(){
  document.querySelectorAll(".sortable-header").forEach(th => {
    th.classList.toggle("active-sort", sortCriteria.some(c => c.field === th.dataset.field));
  });
}

function updateSortIndicator(){
  const el = document.getElementById("sortActiveIndicator");
  if (!el) return;

  const labels = { nombre: "Nombre", club_id: "Club", categoria: "Categoría", torneos: "Jugados" };
  const activos = sortFieldOrder.filter(field => sortCriteria.some(c => c.field === field));

  if (!activos.length) {
    el.innerHTML = "Orden activo: <strong>ninguno</strong>";
    return;
  }

  el.innerHTML = `Orden activo: <strong>${activos.map(f => labels[f]).join(" + ")}</strong>`;
}

function toggleSortCriterion(field){
  const existingIndex = sortCriteria.findIndex(c => c.field === field);
  if (existingIndex >= 0) {
    sortCriteria.splice(existingIndex, 1);
  } else {
    const defaultDirection = field === "categoria" || field === "torneos" ? "desc" : "asc";
    sortCriteria.push({ field, direction: defaultDirection });
  }

  if (typeof window.cargarJugadores === "function") {
    window.cargarJugadores();
  }
}

function getSortValue(jugador, field, db){
  if (field === "club_id") {
    const club = db.clubes.find(c => c.id === jugador.club_id);
    return club?.nombre || "";
  }
  if (field === "categoria") {
    return categoryOrder[jugador.categoria] || 0;
  }
  if (field === "torneos") {
    return Number(jugador.torneos || 0);
  }
  return String(jugador[field] || "").toLowerCase();
}

function compareValues(a, b, direction){
  if (a < b) return direction === "asc" ? -1 : 1;
  if (a > b) return direction === "asc" ? 1 : -1;
  return 0;
}

/* ================= Cargar datos ================= */
document.addEventListener("DOMContentLoaded", async () => {

  const db = await getDB();

  if (!db) {
    console.error("DB no disponible", db);
    return;
  }

  /* ================= Torneos Federados ================= */
  const fed = document.getElementById("torneosFederados");
  fed.innerHTML = "";
  db.torneosFederados?.forEach((t,i)=>{
    const div=document.createElement("div");
    div.className="club-card";

    const inscriptosData = typeof t.inscriptos === "string"
      ? (() => { try { return JSON.parse(t.inscriptos); } catch { return {}; } })()
      : (t.inscriptos || {});

    const inscriptosHtml = Object.entries(inscriptosData)
      .map(([club, jugadores]) => `
        <li>
          <strong>${club}:</strong>
          ${Array.isArray(jugadores) && jugadores.length ? jugadores.join(", ") : "-"}
        </li>
      `)
      .join("");

    div.innerHTML=`
      <h3>Torneo Federado #${t.id}</h3>
      <p><strong>Fecha:</strong> ${t.fecha}</p>
      <p><strong>Observación:</strong> ${t.observacion}</p>
      <p><strong>Inscriptos por club:</strong></p>
      <ul>${inscriptosHtml || "<li>-</li>"}</ul>
    `;
    fed.appendChild(div);
  });

  /* ================= Torneos Internos ================= */
  const internos = document.getElementById("torneosInternos");
  internos.innerHTML = "";
  db.torneosInternos?.forEach(t=>{
    const div=document.createElement("div");
    div.className="club-card";
    div.innerHTML=`
      <h3>${t.nombre}</h3>
      <p><strong>Fecha:</strong> ${t.fecha}</p>
      <p><strong>Organiza:</strong> ${t.clubes?.nombre || "Asociación"}</p>
      <p>${t.descripcion}</p>
    `;
    internos.appendChild(div);
  });

  /* ================= Torneo (nuevo bloque dinámico) ================= */
  const torneoActivoEl = document.getElementById("torneoActivo");
  const torneoProximosEl = document.getElementById("torneoProximosPartidos");

  const torneosOrdenados = [...(db.torneosFederados || [])]
    .sort((a, b) => String(b.fecha || "").localeCompare(String(a.fecha || "")));

  const torneoActivo = torneosOrdenados[0];
  if (torneoActivo) {
    torneoActivoEl.innerHTML = `
      <p><strong>Activo:</strong> Torneo Federado #${torneoActivo.id}</p>
      <p><strong>Fecha:</strong> ${torneoActivo.fecha || "-"}</p>
      <p><strong>Observación:</strong> ${torneoActivo.observacion || "-"}</p>
    `;

    const proximos = [];
    const inscriptos = torneoActivo.inscriptos || {};
    Object.entries(inscriptos).forEach(([club, jugadores]) => {
      (jugadores || []).forEach(jugador => {
        proximos.push(`<li>${jugador} (${club})</li>`);
      });
    });

    torneoProximosEl.innerHTML = proximos.length
      ? `<ul>${proximos.join("")}</ul>`
      : "<p>Sin próximos partidos cargados todavía.</p>";
  } else {
    torneoActivoEl.innerHTML = "<p>No hay torneos activos.</p>";
    torneoProximosEl.innerHTML = "<p>No hay próximos partidos cargados.</p>";
  }

  /* ================= CLUBES =================== */

  const jugadoresPorClub = {};
  db.jugadores.forEach(j => {
    if (!jugadoresPorClub[j.club_id]) {
      jugadoresPorClub[j.club_id] = [];
    }
    jugadoresPorClub[j.club_id].push(j);
  });

  const contClubes = document.getElementById("clubesContainer");
  contClubes.innerHTML = "";

  db.clubes.forEach((club, i) => {
    const jugadores = jugadoresPorClub[club.id] || [];

    const card = document.createElement("div");
    card.className = "club-card";
    card.innerHTML = `
      <h3>${club.nombre}</h3>
      ${club.logo_url ? `<img src="${club.logo_url}" alt="Logo ${club.nombre}" style="max-width:120px;max-height:120px;object-fit:contain;margin:8px 0;">` : ""}
      <p><strong>Ubicación:</strong> ${club.ubicacion}</p>
      <button class="simple" onclick="toggle('club-${i}')">Ver club</button>
      <div id="club-${i}" class="club-details">
        <ul>
          ${["Primera","Segunda","Tercera"].map(cat => `
            <li>
              <strong>${cat}:</strong>
              ${
                jugadores
                  .filter(j => j.categoria === cat)
                  .map(j => j.nombre)
                  .join(", ") || "-"
              }
            </li>
          `).join("")}
        </ul>
      </div>
    `;
    contClubes.appendChild(card);
  });

  /* ================= Jugadores ================= */

 window.cargarJugadores = function(){
  const tbody = document.getElementById("tablaJugadoresBody");
  tbody.innerHTML = "";

  const criteriosActivos = sortFieldOrder
    .map(field => sortCriteria.find(c => c.field === field))
    .filter(Boolean);

  const jugadoresOrdenados = [...db.jugadores].sort((a, b) => {
    for (const criterion of criteriosActivos) {
      const av = getSortValue(a, criterion.field, db);
      const bv = getSortValue(b, criterion.field, db);
      const result = compareValues(av, bv, criterion.direction);
      if (result !== 0) return result;
    }
    return 0;
  });

  jugadoresOrdenados.forEach(j => {

    const club = db.clubes.find(c => c.id === j.club_id);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${j.nombre}</td>
      <td>${club?.nombre || "-"}</td>
      <td>${j.categoria}</td>
      <td>${j.torneos}</td>
      <td>${j.ronda1}</td>
      <td>${j.zona}</td>
      <td>${j.dieciseisavos}</td>
      <td>${j.octavos}</td>
      <td>${j.cuartos}</td>
      <td>${j.semifinal}</td>
      <td>${j.subcampeon}</td>
      <td>${j.campeon}</td>
    `;

    tbody.appendChild(tr);
  });

  updateSortHeaders();
  updateSortIndicator();
};

  showSection('inicio');

});

</script>

