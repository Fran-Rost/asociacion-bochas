<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ADMIN - Asociación de Bochas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="database.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f2f2f2}
.section{padding:25px}
.box{background:#fff;padding:20px;border-radius:6px;margin-bottom:25px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #999;padding:6px;text-align:center}
th{background:#8b0000;color:#fff}
button{padding:5px 10px;margin:3px;cursor:pointer}
input,select{padding:4px}
.table-visor{max-height:400px;overflow:auto}
.club-block{border:1px solid #ccc;padding:10px;margin-bottom:10px}
</style>
</head>

<body>

<div class="section">

<!-- ================= CLUBES ================= -->
<div class="box">
<h2>Clubes</h2>
<div id="clubesAdmin"></div>

<h3>Agregar club</h3>
Nombre: <input id="nuevoClubNombre">
Ubicación: <input id="nuevoClubUbicacion">
<button onclick="agregarClub()">Agregar</button>
</div>

<!-- ================= JUGADORES ================= -->
<div class="box">
<h2>Jugadores</h2>

<div class="table-visor">
<table>
<thead>
<tr>
<th>Nombre</th>
<th>Club</th>
<th>Categoría</th>
<th>Torneos</th>
<th>1°</th>
<th>Zona</th>
<th>16°</th>
<th>8°</th>
<th>4°</th>
<th>SF</th>
<th>Sub</th>
<th>Campeón</th>
<th>Eliminar</th>
</tr>
</thead>
<tbody id="tablaJugadores"></tbody>
</table>
</div>

<h3>Agregar jugador</h3>
Nombre: <input id="nuevoJugadorNombre">
Club: <select id="nuevoJugadorClub"></select>
Categoría:
<select id="nuevoJugadorCategoria">
<option>Primera</option>
<option>Segunda</option>
<option>Tercera</option>
</select>

<button onclick="agregarJugador()">Agregar</button>
</div>

<!-- ================= TORNEOS FEDERADOS ================= -->
<div class="box">
<h2>Torneos Federados</h2>
<div id="federadosAdmin"></div>

<h3>Crear torneo federado</h3>
Fecha: <input type="date" id="fedFecha">
Observación: <input id="fedObs">
<button onclick="crearFederado()">Crear</button>
</div>

<!-- ================= TORNEOS INTERNOS ================= -->
<div class="box">
<h2>Torneos Internos</h2>
<div id="internosAdmin"></div>

<h3>Crear torneo interno</h3>
Organizador:
<select id="intOrg"></select><br><br>
Nombre: <input id="intNombre"><br><br>
Fecha: <input type="date" id="intFecha"><br><br>
Descripción: <input id="intDesc"><br><br>

<button onclick="crearInterno()">Crear</button>
</div>

</div>

<script>
let db;

document.addEventListener("DOMContentLoaded", async ()=>{
  await cargarTodo();
});

async function cargarTodo(){
  db = await getDB();
  renderClubes();
  renderJugadores();
  renderFederados();
  renderInternos();
  cargarSelects();
}

/* ================= CLUBES ================= */

function renderClubes(){
  const cont = document.getElementById("clubesAdmin");
  cont.innerHTML="";

  db.clubes.forEach(c=>{
    cont.innerHTML+=`
      <div class="club-block">
        <input value="${c.nombre}" onchange="actualizarClub(${c.id}, this.value, '${c.ubicacion}')">
        <input value="${c.ubicacion}" onchange="actualizarClub(${c.id}, '${c.nombre}', this.value)">
        <button onclick="eliminarClub(${c.id})">Eliminar</button>
      </div>
    `;
  });
}

async function agregarClub(){
  await crearClub(nuevoClubNombre.value,nuevoClubUbicacion.value);
  await cargarTodo();
}

async function eliminarClub(id){
  if(!confirm("Eliminar club y sus jugadores?")) return;
  await eliminarClubDB(id);
  await cargarTodo();
}

/* ================= JUGADORES ================= */

function renderJugadores(){
  const tbody=document.getElementById("tablaJugadores");
  tbody.innerHTML="";

  db.jugadores.forEach(j=>{
    tbody.innerHTML+=`
    <tr>
      <td><input value="${j.nombre}" onchange="actualizarJugador(${j.id},{nombre:this.value})"></td>
      <td>
        <select onchange="actualizarJugador(${j.id},{club_id:parseInt(this.value)})">
          ${db.clubes.map(c=>`
            <option value="${c.id}" ${c.id===j.club_id?"selected":""}>${c.nombre}</option>
          `).join("")}
        </select>
      </td>
      <td>
        <select onchange="actualizarJugador(${j.id},{categoria:this.value})">
          <option ${j.categoria==="Primera"?"selected":""}>Primera</option>
          <option ${j.categoria==="Segunda"?"selected":""}>Segunda</option>
          <option ${j.categoria==="Tercera"?"selected":""}>Tercera</option>
        </select>
      </td>
      ${["torneos","ronda1","zona","dieciseisavos","octavos","cuartos","semifinal","subcampeon","campeon"].map(campo=>`
        <td>
          <input type="number" value="${j[campo]||0}"
          onchange="actualizarJugador(${j.id},{${campo}:parseInt(this.value)||0})">
        </td>
      `).join("")}
      <td><button onclick="eliminarJugador(${j.id})">X</button></td>
    </tr>
    `;
  });
}

async function agregarJugador(){
  await crearJugador({
    nombre:nuevoJugadorNombre.value,
    categoria:nuevoJugadorCategoria.value,
    club_id:parseInt(nuevoJugadorClub.value),
    torneos:0,ronda1:0,zona:0,dieciseisavos:0,
    octavos:0,cuartos:0,semifinal:0,subcampeon:0,campeon:0
  });
  await cargarTodo();
}

async function eliminarJugador(id){
  if(!confirm("Eliminar jugador?")) return;
  await eliminarJugadorDB(id);
  await cargarTodo();
}

/* ================= FEDERADOS ================= */

async function crearFederado(){
  await crearTorneoFederado({
    fecha:fedFecha.value,
    observacion:fedObs.value
  });
  await cargarTodo();
}

async function renderFederados(){
  const cont=document.getElementById("federadosAdmin");
  cont.innerHTML="";

  const { data: inscriptos } =
    await supabaseClient.from("torneos_federados_inscriptos").select("*");

  db.torneosFederados.forEach(t=>{
    cont.innerHTML+=`
      <div class="club-block">
        <strong>${t.fecha}</strong> - ${t.observacion}
        <button onclick="eliminarFederado(${t.id})">Eliminar</button>
        <div id="ins-${t.id}"></div>
      </div>
    `;

    const div=document.getElementById(`ins-${t.id}`);

    db.clubes.forEach(club=>{
      const jugadoresClub=db.jugadores.filter(j=>j.club_id===club.id);

      div.innerHTML+=`
        <div style="margin-left:15px">
          <strong>${club.nombre}</strong><br>
          ${jugadoresClub.map(j=>{
            const checked=inscriptos.some(i=>
              i.torneo_id===t.id &&
              i.club_id===club.id &&
              i.jugador_id===j.id
            );
            return `
              <label>
                <input type="checkbox"
                  ${checked?"checked":""}
                  onchange="toggleInscripto(${t.id},${club.id},${j.id},this.checked)">
                ${j.nombre}
              </label><br>
            `;
          }).join("")}
        </div>
      `;
    });
  });
}

async function toggleInscripto(torneo_id,club_id,jugador_id,checked){
  if(checked){
    await supabaseClient.from("torneos_federados_inscriptos")
    .insert({torneo_id,club_id,jugador_id});
  }else{
    await supabaseClient.from("torneos_federados_inscriptos")
    .delete()
    .match({torneo_id,club_id,jugador_id});
  }
}

async function eliminarFederado(id){
  if(!confirm("Eliminar torneo federado?")) return;
  await supabaseClient.from("torneos_federados_inscriptos").delete().eq("torneo_id",id);
  await eliminarTorneoFederadoDB(id);
  await cargarTodo();
}

/* ================= INTERNOS ================= */

function renderInternos(){
  const cont=document.getElementById("internosAdmin");
  cont.innerHTML="";

  db.torneosInternos.forEach(t=>{
    cont.innerHTML+=`
      <div class="club-block">
        ${t.nombre} - ${t.fecha} - ${t.clubes?.nombre || "Asociación"}
        <button onclick="eliminarInterno(${t.id})">Eliminar</button>
      </div>
    `;
  });
}

async function crearInterno(){
  await crearTorneoInterno({
    organizador_id:intOrg.value?parseInt(intOrg.value):null,
    nombre:intNombre.value,
    fecha:intFecha.value,
    descripcion:intDesc.value
  });
  await cargarTodo();
}

async function eliminarInterno(id){
  if(!confirm("Eliminar torneo interno?")) return;
  await eliminarTorneoInternoDB(id);
  await cargarTodo();
}

/* ================= SELECTS ================= */

function cargarSelects(){
  const sel=document.getElementById("nuevoJugadorClub");
  const org=document.getElementById("intOrg");
  sel.innerHTML="";
  org.innerHTML="<option value=''>Asociación</option>";

  db.clubes.forEach(c=>{
    sel.innerHTML+=`<option value="${c.id}">${c.nombre}</option>`;
    org.innerHTML+=`<option value="${c.id}">${c.nombre}</option>`;
  });
}
</script>

</body>
</html>
